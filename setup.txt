# This is what Joel did on Windows (Git Bash)
# Docs followed:
# https://github.com/web-arena-x/webarena?tab=readme-ov-file
# https://github.com/web-arena-x/webarena/blob/main/environment_docker/README.md
# https://deepwiki.com/web-arena-x/webarena
#
# I only downloaded Shopping Admin image because it is the smallest in size (~9GB)
# https://github.com/web-arena-x/webarena/blob/main/environment_docker/README.md#:~:text=hostname%3E%3A7770.-,E%2Dcommerce%20Content%20Management%20System%20(CMS)
# Feel free to try other images / evaluations

# 0) One-time prerequisites
# - Install Docker Desktop and make sure Docker Engine is running.
# - Install Python 3.10.x (I used 3.10.4).
# - Use Git Bash (MINGW64) for commands below.

# 1) Activate venv and go to repo
cd /c/Users/Joel/WebArena
source .venv/Scripts/activate

cd /c/Users/Joel/WebArena/webarena

# 2) Install python deps + playwright browsers
pip install -r requirements.txt
pip install -e .
pip install playwright
python -m playwright install

# 3) Create image folder for docker tar files
mkdir -p ~/webarena-images
cd ~/webarena-images

# 4) Downloading images
# I downloaded the .tar manually in the browser and moved it:
mv /c/Users/Joel/Downloads/shopping_admin_final_0719.tar ~/webarena-images/

# 5) Load docker image
docker load --input shopping_admin_final_0719.tar
# Loaded image: shopping_admin_final_0719:latest

# 6) Run container (Shopping Admin only)
docker run --name shopping_admin -p 7780:80 -d shopping_admin_final_0719

docker ps   # should show shopping_admin mapped to 0.0.0.0:7780->80

# 7) IMPORTANT Git Bash path conversion fix
# Without this, docker exec paths like /var/www/... get rewritten into Windows paths.
export MSYS_NO_PATHCONV=1

# 8) Configure Magento base URL (admin site)
docker exec shopping_admin /var/www/magento2/bin/magento setup:store-config:set --base-url="http://localhost:7780"

# Force secure base URL too (helps avoid redirect / mixed URL issues)
docker exec shopping_admin mysql -u magentouser -pMyPassword magentodb -e \
'UPDATE core_config_data SET value="http://localhost:7780/" WHERE path="web/secure/base_url";'

# Flush cache after config changes
docker exec shopping_admin /var/www/magento2/bin/magento cache:flush

# 9) Disable forced password reset + password expiry (so automation login doesn’t get blocked)
docker exec shopping_admin php /var/www/magento2/bin/magento config:set admin/security/password_is_forced 0
docker exec shopping_admin php /var/www/magento2/bin/magento config:set admin/security/password_lifetime 0
docker exec shopping_admin /var/www/magento2/bin/magento cache:flush

# 10) Create a known admin user (since change-password command didn’t exist)
docker exec -it shopping_admin php /var/www/magento2/bin/magento admin:user:create \
  --admin-user=agentadmin \
  --admin-password=AgentPass123! \
  --admin-email=agent@example.com \
  --admin-firstname=Agent \
  --admin-lastname=User

# 11) Back in repo: set ALL required WebArena URLs (env_config.py asserts if any are missing)
cd /c/Users/Joel/WebArena/webarena

export REDDIT="http://localhost:9999"
export SHOPPING="http://localhost:7770"
export SHOPPING_ADMIN="http://localhost:7780/admin"
export GITLAB="http://localhost:8023"
export WIKIPEDIA="http://localhost:8888"
export MAP="http://localhost:3000"
export HOMEPAGE="PASS"

# (Even if you only run admin-only tasks, these env vars must be set.)

# 12) Generate test data (should run once env vars are set)
python scripts/generate_test_data.py

# 13) Create auth folder and run auto-login (creates .auth/*.json state files)
mkdir -p .auth
python browser_env/auto_login.py

# Verify state files exist
ls .auth
# e.g. shopping_admin_state.json

# 14) Model setup (Groq as OpenAI-compatible endpoint)
export OPENAI_API_KEY=YOUR_GROQ_KEY
export OPENAI_API_BASE=https://api.groq.com/openai/v1

# 15) Windows Unicode + cp1252 crash fix (↑ and other unicode chars)
# If you see: UnicodeEncodeError ... cp1252 ... "character maps to <undefined>"
# Force UTF-8:
export PYTHONUTF8=1
export PYTHONIOENCODING=utf-8

# 16) Run WebArena
python run.py \
  --instruction_path agent/prompts/jsons/p_cot_id_actree_2s.json \
  --test_start_idx 41 \
  --test_end_idx 42 \
  --model openai/gpt-oss-120b \
  --result_dir ./results_groq_120b

# This model openai/gpt-oss-120b works for test 41:
# 2026-02-05 16:19:58,607 - INFO - [Intent]: List the top 1 search terms in my store
# 2026-02-05 16:21:23,119 - INFO - [Result] (PASS) C:\Users\Joel\AppData\Local\Temp\tmpmpm35xi5/41.json
# All models fail tests 42-43, so not sure what is wrong
# I chose 120b since it works for test 41 and is not too expensive
# Need to experiment more
